services:
  prometheus-node:
    build: .
    container_name: btc-prometheus
    restart: unless-stopped
    ports:
      - "8333:8333"   # P2P
      # WARNING: RPC port exposed to host. Ensure firewall blocks external access.
      # Cookie auth is enforced, but this port should not be internet-facing.
      - "8332:8332"   # RPC + Metrics (/metrics endpoint)
    volumes:
      - prometheus-data:/home/prometheus/.prometheus
    command:
      - -printtoconsole
      - -rpcallowip=0.0.0.0/0
      - -rpcbind=0.0.0.0

  ui-backend:
    build: ./ui/backend
    container_name: btc-prometheus-api
    restart: unless-stopped
    environment:
      - RPC_HOST=prometheus-node
      - RPC_PORT=8332
      - DATA_DIR=/data
      - CORS_ORIGIN=http://localhost:3000
    volumes:
      - prometheus-data:/data
    depends_on:
      - prometheus-node

  ui-frontend:
    build: ./ui/frontend
    container_name: btc-prometheus-ui
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - ui-backend

  tor-proxy:
    image: peterdavehello/tor-socks-proxy:latest@sha256:1a21ef796e1c8929d3fac4f06dabb1c4e0734fd0b733a54d5d7ef767bd0eaa85
    container_name: btc-prometheus-tor
    restart: unless-stopped

volumes:
  prometheus-data:
